@startuml mcp-security-architecture
!include ../../config/_standard-style.puml

title MCP Security Architecture - Defense in Depth

package "Client Application" {
  [AI Agent] <<agent>> as agent
  [API Client] <<external>> as client
}

package "Authentication Layer" {
  [JWT Token Manager] <<security>> as jwt
  [API Key Manager] <<security>> as apikey
  [OAuth Provider] <<external>> as oauth
  [Token Blacklist] <<storage>> as blacklist
}

package "Authorization Layer" {
  [RBAC System] <<security>> as rbac
  [Permission Manager] <<security>> as perms
  [Role Definitions] <<config>> as roles
}

package "Network Security" {
  [Rate Limiter] <<protection>> as ratelimit
  [DDoS Protection] <<protection>> as ddos
  [TLS Termination] <<encryption>> as tls
  [WAF] <<protection>> as waf
}

package "MCP Server Core" {
  [Secure MCP Server] <<core>> as mcpserver
  [Auth Middleware] <<security>> as middleware
  [Input Validator] <<security>> as validator
  [Audit Logger] <<monitoring>> as audit
}

package "Data Storage" {
  [Redis Cache] <<storage>> as redis
  [User Database] <<storage>> as userdb
  [Audit Database] <<storage>> as auditdb
}

package "Monitoring & Alerting" {
  [Security Dashboard] <<monitoring>> as dashboard
  [Threat Detection] <<security>> as threats
  [Alert Manager] <<notification>> as alerts
}

' Client to Authentication
agent SYNC_LINE tls : HTTPS Request
client SYNC_LINE tls : HTTPS Request
tls SYNC_LINE waf : Filter Traffic
waf SYNC_LINE ratelimit : Rate Check

' Authentication Flow
ratelimit SYNC_LINE middleware : Authenticated Request
middleware SYNC_LINE jwt : Verify JWT
middleware SYNC_LINE apikey : Verify API Key
jwt DATA_LINE blacklist : Check Revocation
jwt DATA_LINE redis : Token Cache
apikey DATA_LINE redis : Key Metadata

' Authorization Flow
middleware SYNC_LINE rbac : Check Permissions
rbac SYNC_LINE perms : Get User Perms
perms DATA_LINE roles : Role Definitions
perms DATA_LINE userdb : User Data

' Request Processing
rbac SYNC_LINE validator : Validate Input
validator SYNC_LINE mcpserver : Execute Tool
mcpserver DATA_LINE redis : Cache Results

' Security Monitoring
middleware ASYNC_LINE audit : Log Events
validator ASYNC_LINE audit : Log Validation
ratelimit ASYNC_LINE audit : Log Rate Limits
audit DATA_LINE auditdb : Store Logs

' Threat Detection
audit ASYNC_LINE threats : Analyze Patterns
threats SYNC_LINE alerts : Trigger Alerts
threats SYNC_LINE dashboard : Update Metrics

' External Integration
oauth OPTIONAL_LINE jwt : SSO Integration
ddos OPTIONAL_LINE waf : Advanced Protection

note right of jwt
  JWT Security Features:
  - Short-lived access tokens (30min)
  - Long-lived refresh tokens (7 days)
  - Token blacklisting for revocation
  - Cryptographically signed (HS256)
end note

note right of rbac
  Role-Based Access Control:
  - Guest: Limited read access
  - User: Standard operations
  - Premium: Extended features
  - Admin: Full system access
end note

note bottom of ratelimit
  Rate Limiting Strategy:
  - Token bucket algorithm
  - Per-user and per-IP limits
  - Burst allowance with sustained rate
  - Redis-backed for scalability
end note

@enduml
@startuml mcp-security-architecture
!include ../../../config/_standard-style.puml

title MCP Security Architecture - Defense in Depth

package "Client Application" {
  [AI Agent] <<agent>> as agent
  [API Client] <<external>> as client
}

package "Authentication Layer" {
  [JWT Token Manager] <<security>> as jwt
  [API Key Manager] <<security>> as apikey
  [OAuth Provider] <<external>> as oauth
  [Token Blacklist] <<storage>> as blacklist
}

package "Authorization Layer" {
  [RBAC System] <<security>> as rbac
  [Permission Manager] <<security>> as perms
  [Role Definitions] <<config>> as roles
}

package "Network Security" {
  [Rate Limiter] <<protection>> as ratelimit
  [DDoS Protection] <<protection>> as ddos
  [TLS Termination] <<encryption>> as tls
  [WAF] <<protection>> as waf
}

package "MCP Server Core" {
  [Secure MCP Server] <<core>> as mcpserver
  [Auth Middleware] <<security>> as middleware
  [Input Validator] <<security>> as validator
  [Audit Logger] <<monitoring>> as audit
}

package "Data Storage" {
  [Redis Cache] <<storage>> as redis
  [User Database] <<storage>> as userdb
  [Audit Database] <<storage>> as auditdb
}

package "Monitoring & Alerting" {
  [Security Dashboard] <<monitoring>> as dashboard
  [Threat Detection] <<security>> as threats
  [Alert Manager] <<notification>> as alerts
}

' Client to Authentication
agent --> tls : HTTPS Request
client --> tls : HTTPS Request
tls --> waf : Filter Traffic
waf --> ratelimit : Rate Check

' Authentication Flow
ratelimit --> middleware : Authenticated Request
middleware --> jwt : Verify JWT
middleware --> apikey : Verify API Key
jwt --> blacklist : Check Revocation
jwt --> redis : Token Cache
apikey --> redis : Key Metadata

' Authorization Flow
middleware --> rbac : Check Permissions
rbac --> perms : Get User Perms
perms --> roles : Role Definitions
perms --> userdb : User Data

' Request Processing
rbac --> validator : Validate Input
validator --> mcpserver : Execute Tool
mcpserver --> redis : Cache Results

' Security Monitoring
middleware --> audit : Log Events
validator --> audit : Log Validation
ratelimit --> audit : Log Rate Limits
audit --> auditdb : Store Logs

' Threat Detection
audit --> threats : Analyze Patterns
threats --> alerts : Trigger Alerts
threats --> dashboard : Update Metrics

' External Integration
oauth ..> jwt : SSO Integration
ddos ..> waf : Advanced Protection

note right of jwt
  JWT Security Features:
  - Short-lived access tokens (30min)
  - Long-lived refresh tokens (7 days)
  - Token blacklisting for revocation
  - Cryptographically signed (HS256)
end note

note right of rbac
  Role-Based Access Control:
  - Guest: Limited read access
  - User: Standard operations
  - Premium: Extended features
  - Admin: Full system access
end note

note bottom of ratelimit
  Rate Limiting Strategy:
  - Token bucket algorithm
  - Per-user and per-IP limits
  - Burst allowance with sustained rate
  - Redis-backed for scalability
end note

@enduml